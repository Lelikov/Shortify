{% extends "admin/base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">URLs</h1>
</div>

<form class="row g-3 mb-4" method="get" action="{{ url_for('list_urls') }}">
    <div class="col-auto">
        <input type="text" class="form-control" name="q" placeholder="Search URLs..." value="{{ q or '' }}">
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary mb-3">Search</button>
    </div>
    {% if q %}
    <div class="col-auto">
        <a href="{{ url_for('list_urls') }}" class="btn btn-secondary mb-3">Clear</a>
    </div>
    {% endif %}
</form>

<form method="post" action="{{ url_for('batch_delete_urls') }}" id="batchDeleteForm" onsubmit="return confirm('Are you sure you want to delete selected URLs?');">
    <div class="mb-2">
        <button type="submit" class="btn btn-danger btn-sm" id="deleteSelectedBtn" disabled>Delete Selected</button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th scope="col"><input type="checkbox" id="selectAll"></th>
                    <th scope="col">Ident</th>
                    <th scope="col">External ID</th>
                    <th scope="col" style="width: 30%;">Origin</th>
                    <th scope="col">Views</th>
                    <th scope="col">
                        <a href="?sort_by=created_at&order={{ 'asc' if sort_by == 'created_at' and order == 'desc' else 'desc' }}&q={{ q or '' }}" class="text-decoration-none text-dark">
                            Created At
                            {% if sort_by == 'created_at' %}
                                <i class="bi bi-arrow-{{ 'down' if order == 'desc' else 'up' }}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">
                        <a href="?sort_by=expires_at&order={{ 'asc' if sort_by == 'expires_at' and order == 'desc' else 'desc' }}&q={{ q or '' }}" class="text-decoration-none text-dark">
                            Expires At
                            {% if sort_by == 'expires_at' %}
                                <i class="bi bi-arrow-{{ 'down' if order == 'desc' else 'up' }}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in urls %}
                <tr>
                    <td><input type="checkbox" name="url_ids" value="{{ u.id }}" class="url-checkbox"></td>
                    <td>
                        <a href="{{ url_for('url_detail', ident=u.ident) }}" class="text-decoration-none fw-bold">{{ u.ident }}</a>
                        <a href="/{{ u.ident }}" target="_blank" class="text-muted small ms-1">â†—</a>
                    </td>
                    <td>{{ u.external_id or '-' }}</td>
                    <td class="text-truncate" style="max-width: 300px;" title="{{ u.origin }}">{{ u.origin }}</td>
                    <td>{{ u.views }}</td>
                    <td>{{ u.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {{ u.expires_at.strftime('%Y-%m-%d %H:%M') if u.expires_at else '-' }}
                        {% if u.expires_at and u.expires_at < now %}
                        <span class="badge bg-danger">Expired</span>
                        {% endif %}
                    </td>
                    <td>
                        <button type="submit" form="deleteForm{{ u.id }}" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

{# Hidden forms for individual delete to avoid nesting forms #}
{% for u in urls %}
<form method="post" action="{{ url_for('delete_url', url_id=u.id) }}" id="deleteForm{{ u.id }}" onsubmit="return confirm('Are you sure you want to delete this URL?');" style="display:none;"></form>
{% endfor %}

<nav aria-label="Page navigation">
    <ul class="pagination">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page - 1 }}&q={{ q or '' }}&sort_by={{ sort_by }}&order={{ order }}">Previous</a>
        </li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link">Page {{ page }} of {{ total_pages or 1 }}</span>
        </li>

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page + 1 }}&q={{ q or '' }}&sort_by={{ sort_by }}&order={{ order }}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.url-checkbox');
    const deleteBtn = document.getElementById('deleteSelectedBtn');

    function updateDeleteBtn() {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        deleteBtn.disabled = !anyChecked;
    }

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateDeleteBtn();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateDeleteBtn);
    });
});
</script>
{% endblock %}
